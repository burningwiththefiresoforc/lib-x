#!/usr/bin/env bash
#A script written by Benexl in September 4, 2024 under GNU GENERAL PUBLIC LICENSE
#vibe coded contributions by burningwiththefiresoforc

CLI_HEADER='
██╗░░░░░██╗██████╗░░░░░░░██╗░░██╗
██║░░░░░██║██╔══██╗░░░░░░╚██╗██╔╝
██║░░░░░██║██████╦╝█████╗░╚███╔╝░
██║░░░░░██║██╔══██╗╚════╝░██╔██╗░
███████╗██║██████╦╝░░░░░░██╔╝╚██╗
╚══════╝╚═╝╚═════╝░░░░░░░╚═╝░░╚═╝
'

CLI_NAME="lib-x"
CLI_VERSION="0.2.0"
CLI_AUTHOR="Benexl"

CLI_DIR="$(dirname "$(realpath "$0")")"
CLI_CONFIG_DIR="$HOME/.config/$CLI_NAME"
CLI_CONFIG_FILE="$CLI_CONFIG_DIR/${CLI_NAME}.conf"
CLI_DBS_DIR="$CLI_CONFIG_DIR/DBS"
CLI_CACHE_DIR="$HOME/.cache/$CLI_NAME"

[[ -d "$CLI_CACHE_DIR" ]] || mkdir -p "$CLI_CACHE_DIR"
[[ -d "$CLI_DBS_DIR" ]] || mkdir -p "$CLI_DBS_DIR"

CALIBRE_CATEGORIES_CSV_FILE="$CLI_CACHE_DIR/calibre_categories.csv"
CACHE_FILE="$CLI_CACHE_DIR/calibre_cache.tsv"

print_config() {
  cat <<EOF
$CLI_HEADER

# whether to show colors when printing ouput
PRETTY_PRINT: $PRETTY_PRINT

# your preferred editor for editing your config
EDITOR: $PREFERRED_EDITOR

# your preferred selector for the tui [fzf/rofi]
PREFERRED_SELECTOR: $PREFERRED_SELECTOR

# whether to show previews [true/false]
# its cool so enable it
ENABLE_PREVIEW: $ENABLE_PREVIEW

# whether to update the recent list kept locally [true/false]
UPDATE_RECENT: $UPDATE_RECENT

# the number of recent books to keep
NO_OF_RECENT: $NO_OF_RECENT

# the path to the calibre library
CALIBRE_LIBRARY_PATH: $CALIBRE_LIBRARY_PATH

# the image renderer to use
IMAGE_RENDERER: $IMAGE_RENDERER

# whether to disown the reading process
DISOWN_READING_PROCESS: $DISOWN_READING_PROCESS

# the number of random books
NO_OF_RANDOM_BOOKS: $NO_OF_RANDOM_BOOKS

# preferred file explorer when adding books etc
FILE_EXPLORER: $FILE_EXPLORER

# preferred terminal when using rofi
PREFERRED_TERMINAL: $PREFERRED_TERMINAL
EOF
}

load_config() {
  config_file="$CLI_CONFIG_FILE"
  [[ -f "$config_file" ]] || touch "$config_file"

  declare -A list_names=(
    ["READING"]="reading_list"
    ["PAUSED"]="paused_list"
    ["PLANING"]="planing_list"
    ["COMPLETED"]="completed_list"
    ["DOCS"]="docs_list"
    ["RECENT"]="recent"
  )
  for key in "${!list_names[@]}"; do
    local var="DB_${key}_LIST"
    local path="$CLI_DBS_DIR/${list_names[$key]}"
    [[ -f "$path" ]] || touch "$path"
    export "$var"="$path"
  done
  declare -A config_defaults=(
    ["CALIBRE_LIBRARY_PATH"]="$HOME/Calibre Library"
    ["PRETTY_PRINT"]="true"
    ["FILE_EXPLORER"]="$(command -v yazi &>/dev/null && echo yazi || echo fzf)"
    ["IMAGE_RENDERER"]="$([[ -n "$KITTY_WINDOW_ID" ]] && echo icat || echo chafa)"
    ["DISOWN_READING_PROCESS"]="true"
    ["PREFERRED_EDITOR"]="${EDITOR:-open}"
    ["PREFERRED_SELECTOR"]="fzf"
    ["ENABLE_PREVIEW"]="false"
    ["UPDATE_RECENT"]="true"
    ["NO_OF_RECENT"]="30"
    ["NO_OF_RANDOM_BOOKS"]="30"
    ["PREFERRED_TERMINAL"]="kitty"
  )
  local config_content
  if [[ -f "$config_file" ]]; then
      config_content=$(<"$config_file")
  fi
  for key in "${!config_defaults[@]}"; do
    local value
    value=$(grep -E "^$key:" <<< "$config_content" | cut -d':' -f2- | sed 's/^[[:space:]]*//')
    [[ -z "$value" ]] && value="${config_defaults[$key]}"
    export "$key"="$value"
  done
  ROFI_THEME=$(grep -E "^ROFI_THEME:" <<< "$config_content" | cut -d':' -f2- | sed 's/^[[:space:]]*//')
  export ROFI_THEME
  FZF_DEFAULT_OPTS=${LIBX_FZF_OPTS:-'
    --color=fg:#d0d0d0,fg+:#d0d0d0,bg:#121212,bg+:#262626
    --color=hl:#5f87af,hl+:#5fd7ff,info:#afaf87,marker:#87ff00
    --color=prompt:#d7005f,spinner:#af5fff,pointer:#af5fff,header:#87afaf
    --color=border:#262626,label:#aeaeae,query:#d9d9d9
    --border="rounded" --border-label="" --preview-window="border-rounded" --prompt="> "
    --marker=">" --pointer="◆" --separator="─" --scrollbar="│"
  '}
  export FZF_DEFAULT_OPTS IMAGE_RENDERER
}

LIB_X_PREVIEW=$(printf '%s\n' \
'if [[ -n {} && {} != "Exit" && {} != "Back" ]]; then' \
'  esc_title=$(echo {} | sed "s/\\//\\\\\\//g; s/\"/\\\\\"/g");' \
'  IFS=$'\''\t'\'' read -r book_id book_title book_authors book_tags book_cover book_comments book_langs book_path < <(' \
'    awk -F"\t" -v title="$esc_title" '\''$2 == title {print; exit}'\'' '"$CACHE_FILE"' );' \
'' \
'  init_pretty_print;' \
'  [[ -s "$book_cover" ]] && fzf_preview "$book_cover";' \
'' \
'  for ((i = 0; i < FZF_PREVIEW_COLUMNS; i++)); do echo -n "─"; done; echo;' \
'  printf "${MAGENTA}${BOLD_LIB_X}Title:${RESET} %s\n" "$book_title";' \
'  printf "${MAGENTA}${BOLD_LIB_X}Authors:${RESET} %s\n" "$book_authors";' \
'  printf "${MAGENTA}${BOLD_LIB_X}Tags:${RESET} %s\n" "$book_tags";' \
'  printf "${MAGENTA}${BOLD_LIB_X}Languages:${RESET} %s\n" "$book_langs";' \
'  for ((i = 0; i < FZF_PREVIEW_COLUMNS; i++)); do echo -n "─"; done; echo;' \
'' \
'  [[ "$book_comments" != "null" && -n "$book_comments" ]] && echo -e "$book_comments";' \
'else' \
'  echo Loading;' \
'fi')

launch_in_terminal() { "$PREFERRED_TERMINAL" -e "$@"; }
#add functionality for other terminals

calibredb_clean() { calibredb "$@" | sed '/Initialized urlfixer/d;/^%$/d'; echo "]"; }
#LOL 

reload_calibre_data() {
  library_timestamp=$(stat -c %Y "$CALIBRE_LIBRARY_PATH")
  if [[ ! -s "$CALIBRE_CATEGORIES_CSV_FILE" || ! -s "$CLI_CACHE_DIR/last_db_timestamp" || "$(<"$CLI_CACHE_DIR/last_db_timestamp")" != "$library_timestamp" || "$FORCE_UPDATE_DB" == "true" ]]; then
    calibredb_clean list_categories --csv | sed '/]$/d' > "$CALIBRE_CATEGORIES_CSV_FILE"
    echo "$library_timestamp" > "$CLI_CACHE_DIR/last_db_timestamp"
     calibredb_clean list --for-machine --fields all | jq -r '
      .[] |
      [
        (.id // "-" | tostring | if . == "" then "-" else . end),
        (.title // "-" | gsub("[\t\n\r]"; " ") | if . == "" then "-" else . end),
        (.authors // "-" | gsub("[\t\n\r]"; " ") | if . == "" then "-" else . end),
        (if (.tags and (.tags | length) > 0) then (.tags | join("; ") | gsub("[\t\n\r]"; " ")) else "-" end),
        (if (.cover and (.cover | tostring) != "") then (.cover | gsub("[\t\n\r]"; " ")) else "-" end),
	(if (.comments and (.comments | tostring) != "") then (.comments | gsub("<[^>]+>"; "") | gsub("[\t\n\r]"; " ") | if . == "null" or . == "" then "-" else . end) else "-" end),
        (if (.languages and (.languages | length) > 0) then (.languages | join("; ") | gsub("[\t\n\r]"; " ")) else "-" end),
	(if (.formats and (.formats | length) > 0) then (.formats | map(split(".")[-1] | ascii_upcase) | join("; ")) else "-" end),
        (if (.series and (.series | length) > 0) then (.series | join("; ") | gsub("[\t\n\r]"; " ")) else "-" end),
        (if (.rating and (.rating | tostring) != "") then (.rating | tostring) else "-" end),
        (.publisher // "-" | gsub("[\t\n\r]"; " ") | if . == "" then "-" else . end),
        (if (.identifiers and (.identifiers | length) > 0) then (.identifiers | to_entries | map("\(.key):\(.value)") | join("; ")) else "-" end),
	(.formats[0] | gsub("[\t\n\r]"; " "))
      ] | @tsv
    ' > "$CACHE_FILE"
  elif [[ -n "$SEARCH" || -n "$SORT_BY" ]]; then
    calibredb_args=(list --for-machine --fields all)
    [[ -n "$SEARCH" ]] && calibredb_args+=(--search "$SEARCH")
    [[ -n "$SORT_BY" ]] && calibredb_args+=(--sort-by "$SORT_BY")
    CALIBRE_DB="$(calibredb_clean "${calibredb_args[@]}")"
  fi
  CALIBRE_CATEGORIES="$(<"$CALIBRE_CATEGORIES_CSV_FILE")"
}

 init_pretty_print() {
  if [[ "$PRETTY_PRINT" == "true" ]]; then
    RED=$(tput setaf 1)
    MAGENTA="\x1b[38;2;215;0;95m"
    CYAN=$(tput setaf 6)
    BOLD_LIB_X=$(tput bold)
    RESET=$(tput sgr0)
    export RED MAGENTA BOLD_LIB_X RESET CYAN
  fi
}

prompt() {
  if [[ "$PREFERRED_SELECTOR" == "rofi" ]]; then
    rofi -dmenu -p "$1: "
  elif command -v "gum" >/dev/null 2>&1; then
    gum input --header "$CLI_HEADER" --prompt "$1: " --value "$2"
  else
    echo "$CLI_HEADER" >/dev/stderr
    printf "%s: " "$1" >/dev/stderr
    read -r VAL
    echo "$VAL"
  fi
}

confirm() {
  if [[ $PREFERRED_SELECTOR == "rofi" ]]; then
    selection=$(printf "No\nYes" | rofi -dmenu -i -p "$1")
    [[ "$selection" == "Yes" ]]
  elif type "gum" >/dev/null 2>&1; then
    gum confirm "$1"
  else
    echo "$CLI_HEADER" > /dev/stderr
    printf "%s: " "$1" > /dev/stderr
    read -r CONFIRMED
    case "$CONFIRMED" in
    [yY]) return 0 ;;
    *) return 1 ;;
    esac
  fi
}

fzf_preview() {
  file=$1
  tty_size=$(stty size </dev/tty)
  rows=${tty_size%% *}
  cols=${tty_size##* }
  dim=${FZF_PREVIEW_COLUMNS}x${FZF_PREVIEW_LINES}
  if [[ "$dim" == "x" ]]; then
	  dim="${cols}x${rows}"
  fi
  if [[ "$IMAGE_RENDERER" != "icat" && -z "$KITTY_WINDOW_ID" && "$((FZF_PREVIEW_TOP + FZF_PREVIEW_LINES))" -eq "$rows" ]]; then
    dim=${FZF_PREVIEW_COLUMNS}x$((FZF_PREVIEW_LINES - 1))
  fi
if [[ "$IMAGE_RENDERER" == "icat" ]]; then
  if command -v kitten >/dev/null 2>&1; then
kitten icat --clear --transfer-mode=memory --unicode-placeholder --stdin=no --place="$dim@0x0" "$file" | sed "\$d" | sed "$(printf "\$s/\$/\033[m/")"
  elif command -v icat >/dev/null 2>&1; then
      icat --clear --transfer-mode=memory --unicode-placeholder --stdin=no --place="$dim@0x0" "$file" | sed "\$d" | sed "$(printf "\$s/\$/\033[m/")"
  else
    if [[ -n "$GHOSTTY_BIN_DIR" ]]; then
      chafa -s "$dim" "$file"
    else
      kitty icat --clear --transfer-mode=memory --unicode-placeholder --stdin=no --place="$dim@0x0" "$file" | sed '$d' | sed "$(printf "\$s/\$/\033[m/")"
    fi
  fi
elif command -v chafa >/dev/null 2>&1; then
    case "$PLATFORM" in
    android) chafa -s "$dim" "$file" ;;
    windows) chafa -f sixel -s "$dim" "$file" ;;
    *) chafa -s "$dim" "$file" ;;
    esac
    echo
  elif command -v imgcat >/dev/null; then
    imgcat -W "${dim%%x*}" -H "${dim##*x}" "$file"
  else
    echo "please install a terminal image viewer" >&2
    echo "either icat for kitty terminal and wezterm or imgcat or chafa" >&2
  fi
}

launcher() {
  case "$PREFERRED_SELECTOR" in
    rofi)
      rofi_args=(-sort -matching fuzzy -dmenu -i -width 1500 -p "" -mesg "Selection:" -sorting-method fzf)
      [[ -n "$ROFI_THEME" ]] && rofi_args=(-no-config -theme "$ROFI_THEME" "${rofi_args[@]}")
      sed -r 's/\x1B(\[[0-9;]*[a-zA-Z]|\(B)//g' | rofi "${rofi_args[@]}"
      ;;
    fzf)
      local fzf_opts_base=(
        --info=hidden
        --layout=reverse
        --height=100%
        --prompt="Selection: "
        --header-first --header="$CLI_HEADER"
        --exact --cycle --ansi
      )
      local fzf_opts_preview=(
        --preview-window=left,35%,wrap
        --bind=right:accept
        --expect=shift-left,shift-right
        --tabstop=1
        --preview="$LIB_X_PREVIEW"
      )
      [[ "$1" == 1 ]] && fzf_opts_base+=("${fzf_opts_preview[@]}")
        fzf "${fzf_opts_base[@]}"
      ;;
    *) notify-send "Calibre" "Unsupported selector: $PREFERRED_SELECTOR"; return 1 ;;
  esac
}

user_lists_manager() {
  declare -A list_dbs=(
    ["Reading"]="$DB_READING_LIST"
    ["Paused"]="$DB_PAUSED_LIST"
    ["Recent"]="$DB_RECENT_LIST"
    ["Completed"]="$DB_COMPLETED_LIST"
    ["Docs"]="$DB_DOCS_LIST"
    ["Planning"]="$DB_PLANING_LIST"
  )
  local list_name="$1"
  local action="$2"
  local db_file="${list_dbs[$list_name]}"
[[ -z "$db_file" ]] && notify-send "Calibre" "Unknown list: $list_name" && return 1
  case "$action" in
    "add")
      if grep -qs "^${title}\$" "$db_file"; then
        notify-send "Calibre" "Already in $list_name list"
      else
        notify-send "Calibre" "Adding to $list_name list..."
        printf "%s\n" "$title" >> "$db_file"
      fi
      ;;
    "remove")
      if grep -q "^$title\$" "$db_file"; then
        if confirm "Are you sure you want to remove '$title' from $list_name List?"; then
          notify-send "Calibre" "Removing from $list_name list..."
          updated_list="$(grep -v "^$title\$" "$db_file")"
          printf "%s\n" "$updated_list" | grep -E '[[:alnum:]]+' > "$db_file"
        fi
      else
        notify-send "Calibre" "'$title' is not in your $list_name list"
      fi
      ;;
    *) notify-send "Calibre" "Unknown action: $action"; return 1 ;;
  esac
}

main() {
  init_pretty_print
  while true; do
    # ---- main menu ----
    if [[ -z "$GO_DIRECTLY_TO" ]]; then
	    _categories="$(awk -F, -v c="$CYAN" -v r="$RESET" 'NR>1 && !seen[$1]++ { $1 = toupper(substr($1,1,1)) substr($1,2); printf("%s%s  %s\n", c, r, $1) }' <<< "$CALIBRE_CATEGORIES")"
action=$( launcher 0 <<< $"${CYAN}${RESET}  All
${_categories}
${CYAN}${RESET}  Recent
${CYAN}${RESET}  Reading-List
${CYAN}${RESET}  Paused
${CYAN}${RESET}  Planning
${CYAN}${RESET}  Completed
${CYAN}${RESET}  Docs
${CYAN}${RESET}  Random
${CYAN}${RESET}  Edit Config
${CYAN}${RESET}  Add Books
${CYAN}${RESET}  Add Books From Folder
${CYAN}${RESET}  Reload Data
${RED}󰈆${RESET}  Exit" )
action="${action#?  }"
else
      action="$GO_DIRECTLY_TO"
      unset GO_DIRECTLY_TO
    fi
    [[ $? -ne 0  ||  -z "$action"  ||  "$action" == "Exit" ]] && exit 0
   # ---- others ----
   case "$action" in
  "All"|"Random")
	  titles="$(cut -f 2 "$CACHE_FILE")"
    [[ "$action" == "Random" ]] && titles=$(shuf -n "$NO_OF_RANDOM_BOOKS" <<< "$titles")
    ;;
    # ---- calibre search ----
   "Formats"|"Series"|"Languages"|"Tags"|"Rating"|"Publisher"|"Identifiers"|"Authors")
   value=$(awk -F, -v f="${action,,}" '$1 == f { print $2 }' <<< "$CALIBRE_CATEGORIES" | launcher 0 | tr -d '"')
  [[ -z "$value" ]] && titles="" && continue

calibre_field=${action,,}

declare -A field_column=(
  [authors]=3
  [tags]=4
  [languages]=7
  [formats]=8
  [series]=9
  [rating]=10
  [publisher]=11
  [identifiers]=12
)

col=${field_column[$calibre_field]}
[[ "$calibre_field" == "authors" || "$calibre_field" == "languages" ]] && calibre_field="${calibre_field::-1}"
if [[ -z "$col" ]]; then
	notify-send "Calibre" "Unknown field: $calibre_field"
	continue
fi

titles=$(awk -v val="$value" -v col="$col" -v field="$calibre_field" -F'\t' '
{
  split($col, parts, /;[ ]*/)
  for (i in parts) {
    if (field == "identifiers") {
      split(parts[i], kv, ":")
      if (kv[1] == val) {
        print $2
        break
      }
    } else {
      if (parts[i] == val) {
        print $2
        break
      }
    }
  }
}
' "$CACHE_FILE")
;;
    # ---- others ----
    "Edit Config")
[[ "$PREFERRED_SELECTOR" == "fzf" ]] && "$PREFERRED_EDITOR" "$CLI_CONFIG_FILE" || launch_in_terminal "$PREFERRED_EDITOR" "$CLI_CONFIG_FILE"
load_config
print_config > "$CLI_CONFIG_FILE"
continue
      ;;
   "Add Books"|"Add Books From Folder")
    local books_path
          if [[ "$FILE_EXPLORER" == "yazi" ]]; then
        [[ "$PREFERRED_SELECTOR" == "rofi" ]] && launch_in_terminal yazi --cwd-file "$CLI_CACHE_DIR/books_path" --chooser-file "$CLI_CACHE_DIR/books_path"
        [[ "$PREFERRED_SELECTOR" == "fzf" ]] && yazi --cwd-file "$CLI_CACHE_DIR/books_path" --chooser-file "$CLI_CACHE_DIR/books_path"
            books_path=$(<"$CLI_CACHE_DIR/books_path")
          elif [[ "$FILE_EXPLORER" == "fzf" ]]; then
	    [[ "$PREFERRED_SELECTOR" == "rofi" ]] && launch_in_terminal bash -c "find \"$HOME\" -type d | fzf" 
	    [[ "$action" == "Add Books From Folder" ]] && books_path=$(find "$HOME" -type d | fzf)
            [[ "$action" == "Add Books" ]] && books_path=$(find "$HOME" -type d | fzf --multi)
          else
            notify-send "Calibre" "Unsupported file explorer"; continue
          fi
            clear
            calibredb add --help
            custom_args=$(prompt "Enter your custom args separated by spaces (default: calibre_db add '$books_path')")
	    if confirm "Would you like to proceed in adding books? [y/n]"; then
  calibredb add "$books_path" "$custom_args" || notify-send "Calibre" "Failed to add books"
fi
  continue
          ;;
   "Reload Data")
          notify-send "Calibre" "Reloading calibre data" && FORCE_UPDATE_DB="true" reload_calibre_data
	  continue
          ;;
  "Reading-List"|"Paused"|"Completed"|"Planning"|"Docs"|"Recent")
    normalized_action="${action//[- ]/_}"
    normalized_action="${normalized_action^^}"
    var_name="DB_${normalized_action}_LIST"
    file="${!var_name}"
if [[ -s "$file" ]]; then
    titles="$(<"$file")"
    [[ "$action" == "Recent" ]] && titles="$(tac "$file")"
    else
	    pretty_name="${action,,}"
      notify-send "Calibre" "You don't have anything in your ${pretty_name} list"; continue
    fi
    ;;
    *) notify-send "Calibre" 'invalid action'; continue ;;
    esac
    # clear
    # book selection loop
    while true; do
      # ---- select book ----
export SHELL="bash"
export -f fzf_preview init_pretty_print
launcher_flag=$([[ "$ENABLE_PREVIEW" == "true" ]] && echo 1 || echo 0)
title=$(launcher "$launcher_flag" <<< "$(printf '%s\nBack\nExit\n' "$titles")" | tr -d '\n')
case "$title" in
  "Exit") exit 0 ;;
  "Back"|"") break ;;
esac
clear
book=$(printf '%s' "$title" | sed 's/"/\\"/g')
           # ---- book actions ----
      while true; do
	      action=$( launcher 0 <<< "${CYAN}${RESET}  Read
${CYAN}${RESET}  Open Folder
${CYAN}${RESET}  Add To List
${CYAN}${RESET}  Remove From List
${CYAN}${RESET}  Remove Book
${CYAN}${RESET}  Edit Metadata
${CYAN}←${RESET}  Back
${RED}󰈆${RESET}  Exit")
action="${action#?  }"
        [[ $? -ne 0 || -z "$action" || "$action" == "Back" ]] && break
        case "$action" in
        "Read"|"Open Folder")
          # update recent list
          if [[ "$UPDATE_RECENT" == "true" ]]; then
		  updated_recent_file_contents="$(awk -v t="$title" -v n="$NO_OF_RECENT" '$0!=t && /[[:alnum:]]/{lines[++c]=$0} END{for(i=c-n+1;i<=c;i++) if(i>0) print lines[i]}' "$DB_RECENT_LIST")"
            printf "%s\n" "$updated_recent_file_contents" > "$DB_RECENT_LIST"
            printf "%s\n" "$title" >> "$DB_RECENT_LIST"
          fi
          # open book or folder
	  book_path="$(awk -F'\t' -v title="$book" '$2 == title {print $13; exit}' "$CACHE_FILE")"
if [[ "$action" == "Read" ]]; then
if opener=$(command -v open || command -v xdg-open); then
  "$opener" "$book_path" &>/dev/null &
else
  notify-send "Calibre" "No supported reader found"
fi
  else
	dir_path="$(dirname "$book_path")"
[[ -d "$dir_path" ]] && "$FILE_EXPLORER" "$dir_path" || notify-send "Calibre" "Folder not found: $dir_path"
	  fi
          # disown
          [[ "${PREFERRED_SELECTOR,,}" == "rofi"  ||  "$DISOWN_READING_PROCESS" == "false" ]] && wait
          [[ "$DISOWN_READING_PROCESS" == "true"  &&  "${PREFERRED_SELECTOR,,}" == "fzf" ]] && disown
          ;;
         "Add To List" | "Remove From List")
		 list_action="${action,,}"
  list_target=$(printf "Reading\nPaused\nPlanning\nRe-reading\nDocs\nCompleted\nDropped\nRecent\n" | launcher 0)
  user_lists_manager "$list_target" "$list_action"
  ;; 
        "Remove Book")
		book_id="$(awk -F'\t' -v title="$book" '$2 == title {print $1; exit}' "$CACHE_FILE")"
          confirm "Are you sure you want to remove $title" 
	  calibredb remove "$book_id" && notify-send "Calibre" "Successfully removed"
          ;;
  "Edit Metadata")
      metadata_field=$( launcher 0 <<< "author_sort
authors
comments
cover
id
identifiers
languages
pubdate
publisher
rating
series
series_index
size
sort
tags
timestamp
title
title_sort
Cancel" )
	[[ -z "$metadata_field" || "$metadata_field" == "Cancel" || $? -ne 0 ]] && notify-send "Calibre" "Metadata editing canceled." && continue
	book_id="$(awk -F'\t' -v title="$book" '$2 == title {print $1; exit}' "$CACHE_FILE")"
	calibredb show_metadata "$book_id"
	metadata_val=$(prompt "Enter new value for $metadata_field")
	[[ -z "$metadata_val" ]] && notify-send "Calibre" "No value entered. Not updated." && continue
	calibredb set_metadata "$book_id" --field "$metadata_field:$metadata_val"
	calibredb backup_metadata
	reload_calibre_data
	;;  
        "Exit") exit 0 ;;
        *) notify-send "Calibre" "invalid action" ;;
        esac
        clear
      done
    done
  done
}

# ---- cli ----
trap exit 0 INT TERM

usage() {
  printf "\
Usage: %s [options] 

Commandline options override the config
Some of the options are directly passed to calibredb

Options:
  -s, --search
    search for a book based on calibredb search syntax
  -S, --sort-by 
    sort the books on a specified field
  -g, --go-directly-to
    open $CLI_NAME with a sub-menu pre-selected
  -e, --edit-config
    edit $CLI_NAME config file
  --rofi-theme <path>
    set the path to your rofi config file
  -d,--disown-reading-process
    disown the reading process so you can contine reading even if you close $CLI_NAME
  -D,--no-disown-reading-process
    don't disown the reading process hence when $CLI_NAME closes the app your using to read your book will also close
  -p <selector>,--preferred-selector <selector>
    set the preferred selector for $CLI_NAME to use
  --preview
    enable the preview window
  --no-preview
    disable the preview window
  -r <number>, --no-of-random-books <number>
    the number of random books to show; also makes the cli auto choose Random sub-menu
  -h, --help
    Show this help message and exit
  -v, --version
    print the $CLI_NAME version and exit
  exit "$1"
  "
}

load_config
[[ ! -s "$CLI_CONFIG_FILE" ]] && print_config > "$CLI_CONFIG_FILE"

while [ $# -gt 0 ]; do
  case "$1" in
  -h|--help) usage 0 ;;
  -v|--version) echo "$CLI_NAME $CLI_VERSION Copyright © 2024 $CLI_AUTHOR projects"; exit 0 ;;
  -e|--edit-config) $PREFERRED_EDITOR "$CLI_CONFIG_FILE" || exit 1; exit 0 ;;
  -g|--go-directly-to) [ -n "$2" ] || usage 1; GO_DIRECTLY_TO="$2"; shift ;;
  -p|--preferred-selector) [ -n "$2" ] || usage 1; PREFERRED_SELECTOR="$2"; shift ;;
  --private) UPDATE_RECENT="false" ;;
  -d|--disown-reading-process) DISOWN_READING_PROCESS="true" ;;
  -D|--no-disown-reading-process) DISOWN_READING_PROCESS="false" ;;
  --preview) ENABLE_PREVIEW="true" ;;
  --no-preview) ENABLE_PREVIEW="false" ;;
  --rofi-theme) [ -n "$2" ] || usage 1; ROFI_THEME="$2"; shift ;;
  -r|--no-of-random-books) [[ -n "$2" ]] || usage 1; NO_OF_RANDOM_BOOKS="$2"; GO_DIRECTLY_TO="${GO_DIRECTLY_TO:-Random}"; shift ;;
  -S|--sort-by) [ -n "$2" ] || usage 1; SORT_BY="$2"; GO_DIRECTLY_TO="${GO_DIRECTLY_TO:-All}"; shift ;;
  -s|--search) [ -n "$2" ] || usage 1; SEARCH="$2"; GO_DIRECTLY_TO="${GO_DIRECTLY_TO:-All}"; shift ;;
  -E|--generate-desktop-entry)
    echo "
[Desktop Entry]
Name=$CLI_NAME
Type=Application
version=$CLI_VERSION
Path=$HOME
Comment=Read and manage your calibre books from the terminal
Terminal=false
Icon=$CLI_DIR/assets/logo.png
Exec=$0 --preferred-selector rofi
Categories=Education
    "
    exit 0
    ;;
  *) usage 1 ;;
  esac
  shift
done

reload_calibre_data
for dep in calibre jq fzf; do
  type "$dep" &>/dev/null || { echo "$dep is required but not installed." >&2; exit 1; }
done
main
